
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Scalecube</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;typescript&quot;,&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="typescript">api</a>
              <a href="#" data-language-name="javascript">example</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#installation" class="toc-h2 toc-link" data-title="Installation">Installation</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#motivation" class="toc-h1 toc-link" data-title="Motivation">Motivation</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#environment" class="toc-h2 toc-link" data-title="Environment">Environment</a>
                  </li>
                  <li>
                    <a href="#reactive-programing" class="toc-h2 toc-link" data-title="Reactive programing.">Reactive programing.</a>
                  </li>
                  <li>
                    <a href="#tools" class="toc-h2 toc-link" data-title="Tools">Tools</a>
                  </li>
                  <li>
                    <a href="#isolation" class="toc-h2 toc-link" data-title="Isolation">Isolation</a>
                  </li>
                  <li>
                    <a href="#scalability" class="toc-h2 toc-link" data-title="Scalability">Scalability</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#core-concepts" class="toc-h1 toc-link" data-title="Core-concepts">Core-concepts</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#member" class="toc-h2 toc-link" data-title="Member">Member</a>
                  </li>
                  <li>
                    <a href="#distributed-environment" class="toc-h2 toc-link" data-title="Distributed environment">Distributed environment</a>
                  </li>
                  <li>
                    <a href="#registry" class="toc-h2 toc-link" data-title="Registry">Registry</a>
                  </li>
                  <li>
                    <a href="#servicecall" class="toc-h2 toc-link" data-title="ServiceCall">ServiceCall</a>
                  </li>
                  <li>
                    <a href="#seedaddress" class="toc-h2 toc-link" data-title="SeedAddress">SeedAddress</a>
                  </li>
                  <li>
                    <a href="#seed" class="toc-h2 toc-link" data-title="Seed">Seed</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#api" class="toc-h1 toc-link" data-title="API">API</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#address" class="toc-h2 toc-link" data-title="Address">Address</a>
                  </li>
                  <li>
                    <a href="#asyncmodel" class="toc-h2 toc-link" data-title="AsyncModel">AsyncModel</a>
                  </li>
                  <li>
                    <a href="#cluster" class="toc-h2 toc-link" data-title="Cluster">Cluster</a>
                  </li>
                  <li>
                    <a href="#discovery" class="toc-h2 toc-link" data-title="Discovery">Discovery</a>
                  </li>
                  <li>
                    <a href="#endpoint" class="toc-h2 toc-link" data-title="Endpoint">Endpoint</a>
                  </li>
                  <li>
                    <a href="#lookup" class="toc-h2 toc-link" data-title="LookUp">LookUp</a>
                  </li>
                  <li>
                    <a href="#message" class="toc-h2 toc-link" data-title="Message">Message</a>
                  </li>
                  <li>
                    <a href="#microservice" class="toc-h2 toc-link" data-title="Microservice">Microservice</a>
                  </li>
                  <li>
                    <a href="#router" class="toc-h2 toc-link" data-title="Router">Router</a>
                  </li>
                  <li>
                    <a href="#service" class="toc-h2 toc-link" data-title="Service">Service</a>
                  </li>
                  <li>
                    <a href="#transport" class="toc-h2 toc-link" data-title="Transport">Transport</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#bootstrap" class="toc-h1 toc-link" data-title="Bootstrap">Bootstrap</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#1-define-the-service" class="toc-h2 toc-link" data-title="1. define the service">1. define the service</a>
                  </li>
                  <li>
                    <a href="#2-create-the-servicereference" class="toc-h2 toc-link" data-title="2. create the serviceReference">2. create the serviceReference</a>
                  </li>
                  <li>
                    <a href="#3-creating-microservice" class="toc-h2 toc-link" data-title="3. creating microservice">3. creating microservice</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#basic-usage" class="toc-h1 toc-link" data-title="Basic usage">Basic usage</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#createproxy" class="toc-h2 toc-link" data-title="createProxy">createProxy</a>
                  </li>
                  <li>
                    <a href="#createservicecall" class="toc-h2 toc-link" data-title="createServiceCall">createServiceCall</a>
                  </li>
                  <li>
                    <a href="#createproxies" class="toc-h2 toc-link" data-title="createProxies">createProxies</a>
                  </li>
                  <li>
                    <a href="#destroy" class="toc-h2 toc-link" data-title="destroy">destroy</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#advance-usage" class="toc-h1 toc-link" data-title="Advance usage">Advance usage</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#remotecall" class="toc-h2 toc-link" data-title="remoteCall">remoteCall</a>
                  </li>
                  <li>
                    <a href="#dependency-hook" class="toc-h2 toc-link" data-title="dependency hook">dependency hook</a>
                  </li>
                  <li>
                    <a href="#gateway" class="toc-h2 toc-link" data-title="gateway">gateway</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#debug" class="toc-h1 toc-link" data-title="Debug">Debug</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#mocks" class="toc-h2 toc-link" data-title="Mocks">Mocks</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#errors" class="toc-h1 toc-link" data-title="Errors">Errors</a>
          </li>
          <li>
            <a href="#faq" class="toc-h1 toc-link" data-title="FAQ">FAQ</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#how-can-i-pass-array-in-message" class="toc-h2 toc-link" data-title="How can I pass array in message?">How can I pass array in message?</a>
                  </li>
                  <li>
                    <a href="#invoking-a-method-from-proxy-throw-error-code-ms0015-can-39-t-find-services" class="toc-h2 toc-link" data-title="Invoking a method from proxy throw error code MS0015 - can't find services ...">Invoking a method from proxy throw error code MS0015 - can't find services ...</a>
                  </li>
                  <li>
                    <a href="#does-the-order-of-services-is-important-when-using-the-dependency-hook" class="toc-h2 toc-link" data-title="Does the order of services is important when using the dependency hook?">Does the order of services is important when using the dependency hook?</a>
                  </li>
                  <li>
                    <a href="#does-seedaddress-and-address-are-mandatory-for-scalecube" class="toc-h2 toc-link" data-title="Does seedAddress and address are mandatory for scalecube?">Does seedAddress and address are mandatory for scalecube?</a>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='https://github.com/scalecube/scalecube-js'>Scalecube github</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Scalecube is a toolkit for creating microservices based systems.</p>

<p>Scalecube provides tools: </p>

<ul>
<li><a href="#bootstrap">Microservice</a><br></li>
<li><a href="#router">Router</a><br></li>
<li><a href="#discovery">Discovery</a><br></li>
<li><a href="#cluster">Cluster</a><br></li>
<li><a href="#transport">Transport</a><br></li>
<li><a href="#gateway">Gateway</a><br></li>
</ul>
<h2 id='installation'>Installation</h2>
<p>yarn:</p>

<p><code>
yarn add @scalecube/scalecube-microservice
</code></p>

<p>npm:</p>

<p><code>
npm install @scalecube/scalecube-microservice
</code> </p>
<h1 id='motivation'>Motivation</h1>
<p>Scalecube implements <a href="https://en.wikipedia.org/wiki/Loose_coupling">Decouple by interface</a> microservice&#39;s architecture.<br>
it is event-base system that allow to create loosely coupled services in a distributed environment.</p>
<h3 id='environment'>Environment</h3>
<p>scalecube can run on both browser and server.</p>

<p>on browser it will use postMessage events.</p>

<p>on server it will use websocket.</p>
<h3 id='reactive-programing'>Reactive programing.</h3>
<p>support Observable pattern.</p>
<h3 id='tools'>Tools</h3>
<p>Provides additional tools:</p>

<ul>
<li><p><strong>workers</strong> - tool for using web-workers in scalecube ecosystem.
&#39;@scalecube/scalecube-microservice&#39; export workers which contain:</p>

<ul>
<li>addWorker - add a web-worker to sclaecube&#39;s ecosystem.</li>
<li>removeWorker -  remove a web-worker from sclaecube&#39;s ecosystem.</li>
</ul></li>
<li><p><strong>stringToAddress</strong> - tool for creating address from string.<br>
receive URI format and convert it to Address.</p>

<ul>
<li>can use partial URI format</li>
<li>use default params to fill the missing values from the given string.</li>
</ul></li>
</ul>

<p>scalecube provide event-base tool for working in microservice approach.</p>
<h2 id='isolation'>Isolation</h2><h3 id='runtime'>RunTime</h3>
<p>Different services communicate via events, this solution isolates each service.
if one of the services throw exception, it won&#39;t break the whole js application.</p>
<h3 id='development'>Development</h3>
<p>Each feature/service can be developed in isolation from other features/services.
services will be able to integrate together base on the interface of each service.</p>
<h2 id='scalability'>Scalability</h2><h3 id='runtime-2'>RunTime</h3>
<p>Easy to bootstrap in every environment/process.</p>
<h4 id='browser'>Browser</h4>
<p>A feature can be located on the main thread or in a web-worker.
Scalecube will manage the communication between the services.
that way scalecube help you to use workers and to scale your runtime processing.</p>
<h4 id='nodejs'>NodeJS</h4><h3 id='development-2'>Development</h3>
<p>Scalecube provide easy way to integrate services base on their definition.</p>
<h1 id='core-concepts'>Core-concepts</h1><h2 id='member'>Member</h2>
<p>member is a microservice instances.</p>
<h2 id='distributed-environment'>Distributed environment</h2>
<p>Distributed environment is collection of members that share services between them.</p>

<p>Each member have access to all the services that are shared in the distributed environment.</p>
<h3 id='possible-topologies'>possible <a href="https://en.wikipedia.org/wiki/Network_topology">topologies:</a></h3>
<ul>
<li>Star - when all microservice container are connected to the same microservice <a href="#seed">seed</a>.</li>
<li>Hybrid - most of the microservices instance act as <a href="#seed">seed</a>.</li>
</ul>
<h2 id='registry'>Registry</h2>
<p>Registry store all <a href="#endpoint">endpoints</a> of the available services it can request.<br>
when a microservice bootstrap with a new service, it is connect via the <a href="#discovery">discovery</a> to the <a href="#seed">microservice seed</a>,<br>
once connection is established, then they share their Endpoints.<br>
every change in the microservices in the <a href="#distributed-environment">distributed environment</a> the registry is notified and update accordingly.</p>
<h2 id='servicecall'>ServiceCall</h2>
<p>ServiceCall is the process of requesting a service to execute.</p>

<p>there are two types of service call:</p>

<ul>
<li>localCall</li>
<li>remoteCall</li>
</ul>
<h3 id='localcall'>LocalCall</h3><pre class="highlight javascript tab-javascript"><code><span class="c1">// main.js</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">createMicroservice</span><span class="p">,</span> <span class="nx">stringToAddress</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube-microservice'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">localMs</span> <span class="o">=</span> <span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">services</span><span class="p">:[{</span>
    <span class="c1">// add your services</span>
  <span class="p">}]</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="nx">localMs</span><span class="p">.</span><span class="nx">createProxy</span><span class="p">({</span>
 <span class="c1">// create proxy to the services on the microservice instance</span>
<span class="p">});</span>
</code></pre>
<p>When a microservice use its own services.</p>

<p><strong>use cases:</strong></p>
<h4 id='monolith-application'>monolith application</h4>
<p>starting building the application as monolith (in this step all services are local)<br>
change the application to microservice architecture when you are ready to scale-up.</p>
<h4 id='gateway'>gateway</h4>
<p>when your microservice also act as a gateway,
some of the requests will be from the local services and some will require propagate the request to another microservice instance.</p>
<h3 id='remotecall'>RemoteCall</h3><pre class="highlight javascript tab-javascript"><code><span class="c1">// seed.js</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">createMicroservice</span><span class="p">,</span> <span class="nx">stringToAddress</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube-microservice'</span><span class="p">;</span>

<span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">address</span><span class="p">:</span> <span class="nx">stringToAddress</span><span class="p">(</span><span class="s1">'seed'</span><span class="p">),</span>
  <span class="na">services</span><span class="p">:[{</span>
    <span class="c1">// add your services</span>
  <span class="p">}]</span>
<span class="p">});</span>

<span class="c1">// main.js</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">createMicroservice</span><span class="p">,</span> <span class="nx">stringToAddress</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube-microservice'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">localMs</span> <span class="o">=</span> <span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">address</span><span class="p">:</span> <span class="nx">stringToAddress</span><span class="p">(</span><span class="s1">'local'</span><span class="p">),</span>
  <span class="na">seedAddress</span> <span class="p">:</span> <span class="nx">stringToAddress</span><span class="p">(</span><span class="s1">'seed'</span><span class="p">),</span>
  <span class="na">services</span><span class="p">:[{</span>
    <span class="c1">// add your services</span>
  <span class="p">}]</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="nx">localMs</span><span class="p">.</span><span class="nx">createProxy</span><span class="p">({</span>
 <span class="c1">// create proxy to the services on the other microservice instance</span>
<span class="p">});</span>
</code></pre>
<p>When a microservice use another microservice&#39;s services.</p>

<p><strong>steps:</strong></p>

<ol>
<li>use seedAddress to connect the microservice to the right distributed environment.</li>
<li>bootstrap the microservice with the seedAddress</li>
<li>createProxy to the service located on the other microservice instance.</li>
</ol>
<h2 id='seedaddress'>SeedAddress</h2>
<p>seedAddress is the <a href="#address">address</a> of the <a href="#seed">seed</a>.</p>
<h2 id='seed'>Seed</h2>
<p>the seed is a microservice container that used as an entry-point to the <a href="#distributed-environment">distributed environment</a>.
each microservice can act as a seed for other microservice containers.</p>
<h1 id='api'>API</h1><h2 id='address'>Address</h2><pre class="highlight typescript tab-typescript"><code><span class="kr">interface</span> <span class="nx">Address</span> <span class="p">{</span>
  <span class="nl">host</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">port</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">protocol</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">path</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Address is the URI for the service.</p>

<ul>
<li>host - unique identifier that allows other computers to access it.</li>
<li>port - determine on which port number the server will receive the data.</li>
<li>protocol - rules for communication between server and client (ws | pm | tcp)</li>
<li>path - relative address.</li>
</ul>
<h2 id='asyncmodel'>AsyncModel</h2><pre class="highlight typescript tab-typescript"><code>
<span class="kd">type</span> <span class="nx">RequestStreamAsyncModel</span> <span class="o">=</span> <span class="s1">'requestStream'</span><span class="p">;</span>

<span class="kd">type</span> <span class="nx">RequestResponseAsyncModel</span> <span class="o">=</span> <span class="s1">'requestResponse'</span><span class="p">;</span>

<span class="kd">type</span> <span class="nx">AsyncModel</span> <span class="o">=</span> <span class="nx">RequestStreamAsyncModel</span> <span class="o">|</span> <span class="nx">RequestResponseAsyncModel</span><span class="p">;</span>
</code></pre>
<p>AsyncModel is the way a service can be resolved.<br>
It can be a stream and use <code>requestStream</code>
or can be a promise and use <code>requestResponse</code></p>

<ul>
<li>RequestStreamAsyncModel - Defines Stream asyncModel ( Observable, Flowable , etc.. ).</li>
<li>RequestResponseAsyncModel - Defines Async asyncModel ( Promise ).</li>
</ul>
<h2 id='cluster'>Cluster</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">JoinCluster</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">ClusterOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Cluster</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">ClusterOptions</span> <span class="p">{</span>
  <span class="nl">address</span><span class="p">:</span> <span class="nx">Address</span><span class="p">;</span>
  <span class="nx">seedAddress</span><span class="p">?:</span> <span class="nx">Address</span><span class="p">;</span>
  <span class="nl">itemsToPublish</span><span class="p">:</span> <span class="kr">any</span><span class="p">;</span>
  <span class="nx">retry</span><span class="p">?:</span> <span class="p">{</span>
    <span class="na">timeout</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">debug</span><span class="p">?:</span> <span class="kr">boolean</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Cluster</span> <span class="p">{</span>
  <span class="na">getCurrentMembersData</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">MembersData</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">listen</span><span class="na">$</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">ClusterEvent</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">destroy</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="c1">// browser: </span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">joinCluster</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/cluster-browser'</span><span class="p">;</span>
<span class="c1">// server:</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">joinCluster</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/cluster-nodejs'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">joinCluster</span><span class="p">({</span>
  <span class="na">address</span><span class="p">:</span> <span class="p">{</span> <span class="cm">/* my address */</span> <span class="p">},</span>
  <span class="na">seedAddress</span><span class="p">:</span> <span class="p">{</span><span class="cm">/* address to the distributed environment */</span><span class="p">},</span>
  <span class="na">itemsToPublish</span><span class="p">:</span> <span class="p">[</span><span class="cm">/* items to publish in the distributed environment */</span><span class="p">]</span>
<span class="p">});</span>

<span class="nx">cluster</span><span class="p">.</span><span class="nx">listen$</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">)});</span>
</code></pre>
<p>create a <a href="#member">member</a> from the data it receive from the discovery,<br>
and use it in-order to share data in the distributed environment.</p>

<p>scalecube provide two cluster implementations:
* browser:<br>
import { joinCluster } from &#39;@scalecube/cluster-browser&#39;;
* server:<br>
import { joinCluster } from &#39;@scalecube/cluster-nodejs&#39;;</p>

<p><code>@scalecube/cluster-browser</code> is the default cluster when using the IIFE version.</p>

<ul>
<li>address - address of the member</li>
<li>seedAddress - address of the member that act as the seed</li>
<li>itemsToPublish - item to share with the different members</li>
<li>retry - retry configuration for connecting members</li>
<li><p>debug - debug flag</p></li>
<li><p>getCurrentMembersData - resolve with the current information of the other members in the distributed environment</p></li>
<li><p>listen$ - subscribe to changes in the members state</p></li>
<li><p>destroy - resolve when cluster is destroyed</p></li>
</ul>
<h2 id='discovery'>Discovery</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">CreateDiscovery</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">DiscoveryOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Discovery</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">DiscoveryOptions</span> <span class="p">{</span>
  <span class="nl">address</span><span class="p">:</span> <span class="nx">Address</span><span class="p">;</span>
  <span class="nl">itemsToPublish</span><span class="p">:</span> <span class="nx">Item</span><span class="p">[];</span>
  <span class="nx">seedAddress</span><span class="p">?:</span> <span class="nx">Address</span><span class="p">;</span>
  <span class="nx">cluster</span><span class="p">?:</span> <span class="p">(</span><span class="nx">opt</span><span class="p">:</span> <span class="nx">ClusterOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Cluster</span><span class="p">;</span>
  <span class="nx">debug</span><span class="p">?:</span> <span class="kr">boolean</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Discovery</span> <span class="p">{</span>
  <span class="nx">discoveredItems$</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">ServiceDiscoveryEvent</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">destroy</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Item</span> <span class="o">=</span> <span class="kr">any</span><span class="p">;</span>
</code></pre>
<p>Discovery is a tool that connect the microservice instance to the <a href="#distributed-environment">distributed environment</a>.  </p>

<p>It convert events received from the <a href="#distributed-environment">distributed environment</a> to events that the registry can understand.</p>

<ul>
<li>address - A unique <a href="#address">address</a>.</li>
<li>itemsToPublish - The data that the discovery need to share.</li>
<li>seedAddress - the <a href="#address">address</a> we want to use in-order to connect to the distributed environment.</li>
<li>cluster - optional pluggable <a href="#cluster">cluster</a></li>
<li><p>debug - discovery logs</p></li>
<li><p>discoveredItems$ - An Observable sequence that describes all the items that published by <strong>other</strong> discoveries.<br>
Emits new array of all items each time new discovery is created or destroyed.</p></li>
<li><p>destroy - Destroy the discovery:  </p>

<ul>
<li>Completes discoveredItems$.<br></li>
<li>Notifies other discoveries that this discovery&#39;s items are not available anymore.<br></li>
<li>Resolves with the message, that specifies the <a href="#address">address</a> of the discovery.</li>
</ul></li>
</ul>
<h2 id='endpoint'>Endpoint</h2><pre class="highlight typescript tab-typescript"><code><span class="kr">interface</span> <span class="nx">Endpoint</span> <span class="p">{</span>
  <span class="nl">qualifier</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">serviceName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">methodName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">asyncModel</span><span class="p">:</span> <span class="nx">AsyncModel</span><span class="p">;</span>
  <span class="nl">address</span><span class="p">:</span> <span class="nx">Address</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Endpoint is the metadata of a service.<br>
Contain information of how to access the service.</p>

<ul>
<li>qualifier - The combination of serviceName and methodName: <serviceName/methodName></li>
<li>serviceName - The name of a service, that is provided in serviceDefinition.</li>
<li>methodName - The name of a method, that is provided in the methods map in serviceDefinition.</li>
<li>asyncModel - Type of communication between a consumer and a provider.</li>
<li>address - A unique <a href="#address">address</a> of an endpoint URI format: <protocol>://<host>:<port>/<path></li>
</ul>
<h2 id='lookup'>LookUp</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">LookUp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">LookupOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Endpoint</span><span class="p">[]</span> <span class="o">|</span> <span class="p">[];</span>

<span class="kr">interface</span> <span class="nx">LookupOptions</span> <span class="p">{</span>
  <span class="nl">qualifier</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Search for <a href="#endpoint">endPoints</a> in the registry that match the qualifier.</p>

<ul>
<li>qualifier - The combination of serviceName and methodName: <serviceName/methodName></li>
</ul>
<h2 id='message'>Message</h2><pre class="highlight typescript tab-typescript"><code><span class="kr">interface</span> <span class="nx">Message</span> <span class="p">{</span>
  <span class="nl">qualifier</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">[];</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">qualifier</span> <span class="p">:</span> <span class="s1">'Service/someMethod'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">[</span><span class="s1">'value'</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
<p>structure of the data in scalecube.</p>

<ul>
<li>qualifier - The combination of serviceName and methodName: <serviceName/methodName></li>
<li>data - Arguments of the invoked function.</li>
</ul>
<h2 id='microservice'>Microservice</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">CreateMicroservice</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">MicroserviceOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Microservice</span><span class="p">;</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">Microservice</span> <span class="p">{</span>
  <span class="nl">destroy</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">createProxies</span><span class="p">:</span> <span class="nx">CreateProxies</span><span class="p">;</span>
  <span class="nl">createProxy</span><span class="p">:</span> <span class="nx">CreateProxy</span><span class="p">;</span>
  <span class="nl">createServiceCall</span><span class="p">:</span> <span class="nx">CreateServiceCall</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">MicroserviceOptions</span> <span class="p">{</span>
  <span class="nx">services</span><span class="p">?:</span> <span class="nx">Service</span><span class="p">[];</span>
  <span class="nx">seedAddress</span><span class="p">?:</span> <span class="nx">Address</span> <span class="o">|</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nx">address</span><span class="p">?:</span> <span class="nx">Address</span> <span class="o">|</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nx">transport</span><span class="p">?:</span> <span class="nx">Transport</span><span class="p">;</span>
  <span class="nx">cluster</span><span class="p">?:</span> <span class="p">(</span><span class="nx">opt</span><span class="p">:</span> <span class="nx">ClusterOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Cluster</span><span class="p">;</span>
  <span class="nx">debug</span><span class="p">?:</span> <span class="kr">boolean</span><span class="p">;</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">createMicroservice</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube-microservice'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">TransportNodeJS</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/transport-nodejs'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">joinCluster</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/cluster-nodejs'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">microserviceInstance</span> <span class="o">=</span> <span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">services</span><span class="p">:</span> <span class="p">[</span><span class="cm">/* array of services */</span><span class="p">],</span>
  <span class="na">seedAddress</span> <span class="p">:</span> <span class="s1">'pm://myOrganization:8080/ServiceA'</span><span class="p">,</span>
  <span class="na">address</span> <span class="p">:</span> <span class="p">{</span>
    <span class="na">protocol</span> <span class="p">:</span> <span class="s1">'pm'</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'myOrganization'</span><span class="p">,</span>
    <span class="na">port</span> <span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
    <span class="na">path</span><span class="p">:</span> <span class="s1">'ServiceB'</span>
  <span class="p">},</span>
  <span class="na">transport</span><span class="p">:</span> <span class="nx">TransportNodeJS</span><span class="p">,</span> <span class="c1">// scalecube provide a default transport configuration when running on browser,</span>
  <span class="na">cluster</span><span class="p">:</span> <span class="nx">joinCluster</span><span class="p">,</span> <span class="c1">// scalecube provide a default cluster configuration when running on browser,</span>
  <span class="na">debug</span><span class="p">:</span> <span class="kc">true</span> <span class="c1">// default is false</span>
<span class="p">})</span>
</code></pre>
<ul>
<li><a href="#destroy">destroy</a> - The method is used to delete a microservice and close all the subscriptions related with it.</li>
<li><a href="#createproxies">createProxies</a> - Create a map of proxies or Promises to proxy. (deepened on configuration)</li>
<li><a href="#createproxy">createProxy</a> - Creates a proxy to a method and provides extra logic when is invoked.</li>
<li><p><a href="#createServiceCall">createServiceCall</a> - Exposes serviceCall to a user (not via Proxy)</p></li>
<li><p>services - An array of <a href="#service">services</a>, that will exist inside a microservice container</p></li>
<li><p>seedAddress - The seedAddress is an <a href="#address">address</a> or a <strong>string (URI format)</strong> of another microservice container in our distributed env.</p></li>
<li><p>address - An <a href="#address">address</a> or a <strong>string (URI format)</strong> for this microservice instance, other microservices can use this address to connect with this microservice container.</p></li>
<li><p>transport - a module that implements MicroserviceTransport.</p></li>
<li><p>cluster - a module that implements <a href="#cluster">Cluster</a> API</p></li>
<li><p>debug - add logs</p></li>
</ul>
<h2 id='router'>Router</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">roundRobin</span><span class="p">,</span> <span class="nx">retryRouter</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/routers'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">proxyA</span> <span class="o">=</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">createProxy</span><span class="p">({</span><span class="nx">serviceDefinition</span><span class="p">,</span> <span class="na">router</span><span class="p">:</span> <span class="nx">roundRobin</span><span class="p">});</span>

<span class="kr">const</span> <span class="nx">proxyB</span> <span class="o">=</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">createProxy</span><span class="p">({</span><span class="nx">serviceDefinition</span><span class="p">,</span> <span class="na">router</span><span class="p">:</span> <span class="nx">retryRouter</span><span class="p">({</span><span class="na">period</span><span class="p">:</span> <span class="mi">10</span><span class="p">})});</span>
</code></pre><pre class="highlight typescript tab-typescript"><code>
<span class="kd">type</span> <span class="nx">Router</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">RouterOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Endpoint</span><span class="o">&gt;</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">RouterOptions</span> <span class="p">{</span>
  <span class="nl">lookUp</span><span class="p">:</span> <span class="nx">LookUp</span><span class="p">;</span>
  <span class="nl">message</span><span class="p">:</span> <span class="nx">Message</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">type</span> <span class="nx">RetryRouter</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">RetryRouterOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Router</span>

<span class="kr">interface</span> <span class="nx">RetryRouterOptions</span> <span class="p">{</span> 
  <span class="nl">period</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span> 
  <span class="nx">maxRetry</span><span class="p">?:</span> <span class="kr">number</span> 
<span class="p">}</span>
</code></pre>
<p>router is a tool for picking the best service base on given criteria.</p>

<ul>
<li>lookUp - The function that finds <a href="#endpoint">Endpoint</a> by given criteria.</li>
<li>message - metadata, contain criteria for picking the <a href="#endpoint">Endpoint</a></li>
</ul>
<h3 id='default'>default</h3>
<p>pick the first available item.</p>
<h3 id='roundrobin'>RoundRobin</h3>
<p>pick the next item from a list of available items.</p>
<h3 id='retryrouter'>retryRouter</h3>
<p>ping the registry every @ms and checking if there are any available items.
pick the first available item.</p>
<h2 id='service'>Service</h2><pre class="highlight typescript tab-typescript"><code><span class="kr">interface</span> <span class="nx">Service</span> <span class="p">{</span>
  <span class="nl">definition</span><span class="p">:</span> <span class="nx">ServiceDefinition</span><span class="p">;</span>
  <span class="nl">reference</span><span class="p">:</span> <span class="nx">ServiceReference</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ServiceDefinition</span> <span class="p">{</span>
  <span class="nl">serviceName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">methodName</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="p">{</span>
      <span class="nl">asyncModel</span><span class="p">:</span> <span class="nx">AsyncModel</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ServiceReference</span> <span class="o">=</span> <span class="nx">ServiceFactory</span> <span class="o">|</span> <span class="nx">ServiceObject</span><span class="p">;</span>

<span class="kd">type</span> <span class="nx">ServiceFactory</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">createProxy</span><span class="p">,</span> <span class="nx">createServiceCall</span> <span class="p">}:</span> <span class="nx">ServiceFactoryOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ServiceObject</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">ServiceObject</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">?:</span> <span class="kr">any</span><span class="p">;</span>

  <span class="p">[</span><span class="nx">methodName</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ServiceFactoryOptions</span> <span class="p">{</span>
  <span class="nl">createProxy</span><span class="p">:</span> <span class="nx">CreateProxy</span><span class="p">;</span>
  <span class="nl">createServiceCall</span><span class="p">:</span> <span class="nx">CreateServiceCall</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Service is combination of contract and the reference that uphold the contract.  </p>

<ul>
<li>definition - metadata that define the service.</li>
<li>reference - code of the service</li>
</ul>
<h3 id='servicedefinition'>ServiceDefinition</h3>
<p>Its the contract that describe the service.</p>

<ul>
<li>serviceName - The name of a service</li>
<li>methods - Map of methods that exist in the service.<br>
each method describe its <a href="#asyncmodel">asyncModel</a>.</li>
</ul>
<h3 id='servicereference'>ServiceReference</h3>
<p>Its the code of the service.</p>

<ul>
<li>ServiceFactory - callback that provide life-cycle/inject hook in the bootstrap process.</li>
<li>ServiceObject - object that contains the functionality described in the serviceDefinition.</li>
</ul>
<h2 id='transport'>Transport</h2><pre class="highlight typescript tab-typescript"><code><span class="kr">interface</span> <span class="nx">Transport</span> <span class="p">{</span>
  <span class="nl">clientProvider</span><span class="p">:</span> <span class="nx">Provider</span><span class="p">;</span>
  <span class="nl">serverProvider</span><span class="p">:</span> <span class="nx">Provider</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Provider</span> <span class="p">{</span>
  <span class="nl">providerFactory</span><span class="p">:</span> <span class="nx">ProviderFactory</span><span class="p">;</span>
  <span class="nx">factoryOptions</span><span class="p">?:</span> <span class="kr">any</span><span class="p">;</span>
  <span class="nx">serializers</span><span class="p">?:</span> <span class="nx">PayloadSerializers</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">PayloadSerializers</span> <span class="p">{</span>
  <span class="nl">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">deserialize</span><span class="p">:</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">;</span>
    <span class="nl">serialize</span><span class="p">:</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nl">metadata</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">deserialize</span><span class="p">:</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">;</span>
    <span class="nl">serialize</span><span class="p">:</span> <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ProviderFactory</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="p">{</span> <span class="nl">address</span><span class="p">:</span> <span class="nx">Address</span><span class="p">;</span> <span class="nx">factoryOptions</span><span class="p">?:</span> <span class="kr">any</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">DuplexConnection</span><span class="p">;</span>

<span class="kd">type</span> <span class="nx">DuplexConnection</span> <span class="o">=</span> <span class="kr">any</span><span class="p">;</span>
</code></pre>
<p>Opinionated communication layer.<br>
It is used when requesting a service from another microservice instance.</p>

<p>When bootstrapping microservice, it is possible to pass transport in the <a href="#microservice">options</a>.</p>

<p>transport is your custom implementation to <a href="https://github.com/rsocket/rsocket-js">RSocket</a> Transport Providers.</p>

<ul>
<li>clientProvider - implementation for the client side.</li>
<li><p>serverProvider - implementation for the server side.</p></li>
<li><p>providerFactory - Factory for creating RSocket client transport provider</p></li>
<li><p>factoryOptions - Extra configuration to pass to the factory</p></li>
<li><p>serializers - Optional serialize functionality for the payload</p></li>
</ul>
<h1 id='bootstrap'>Bootstrap</h1>
<p>bootstrap the microservice can be done in 3 steps:</p>
<h2 id='1-define-the-service'>1. define the service</h2><pre class="highlight typescript tab-typescript"><code><span class="kr">interface</span> <span class="nx">ServiceDefinition</span> <span class="p">{</span>
  <span class="nl">serviceName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">methodName</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="p">{</span>
      <span class="nl">asyncModel</span><span class="p">:</span> <span class="nx">AsyncModel</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">ASYNC_MODEL_TYPES</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube-microservice'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">serviceDefinition</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">serviceName</span><span class="p">:</span> <span class="s1">'Service'</span><span class="p">,</span>
  <span class="na">methods</span><span class="p">:{</span>
  <span class="na">someMethod</span> <span class="p">:</span> <span class="p">{</span>
    <span class="na">asyncModel</span> <span class="p">:</span> <span class="nx">ASYNC_MODEL_TYPES</span><span class="p">.</span><span class="nx">RequestResponse</span>
    <span class="p">}</span>
  <span class="p">}</span> 
<span class="p">}</span>
</code></pre>
<p><a href="#service">service</a> definition is the contract between the provider to the consumer of the service.<br>
in other words, it is the contract that the service must uphold.</p>

<p>service definition is used when we are bootstrapping a service
and when we are creating a proxy to a service.</p>

<p>when we are boostraping the service we are binding the serviceReference with the serviceDefinition.
when we are creating a proxy with a serviceDefinition then scalecube search for the serviceReference that is bound to the serviceDefinition. </p>
<h2 id='2-create-the-servicereference'>2. create the serviceReference</h2><pre class="highlight javascript tab-javascript"><code><span class="c1">// class example</span>
<span class="kr">class</span> <span class="nx">Service</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(){</span>

  <span class="p">}</span>

  <span class="nx">someMethod</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'some method been resolved'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// module example</span>
<span class="kr">const</span> <span class="nx">someMethod</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'some method been resolved'</span><span class="p">);</span>

</code></pre><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">ServiceReference</span> <span class="o">=</span> <span class="nx">ServiceFactory</span> <span class="o">|</span> <span class="nx">ServiceObject</span><span class="p">;</span>

<span class="kd">type</span> <span class="nx">ServiceFactory</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">createProxy</span><span class="p">,</span> <span class="nx">createServiceCall</span> <span class="p">}:</span> <span class="nx">ServiceFactoryOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ServiceObject</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">ServiceObject</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">?:</span> <span class="kr">any</span><span class="p">;</span>

  <span class="p">[</span><span class="nx">methodName</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ServiceFactoryOptions</span> <span class="p">{</span>
  <span class="nl">createProxy</span><span class="p">:</span> <span class="nx">CreateProxy</span><span class="p">;</span>
  <span class="nl">createServiceCall</span><span class="p">:</span> <span class="nx">CreateServiceCall</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>ServiceReference is the implementation of the contract.</p>

<p>It can be a class instance, module or a callback function.</p>

<p>passing callback function in the ServiceReference call <a href="#dependency-hook">depedency hook</a> 
and it can be used to inject proxy/service call to the service.</p>

<p>it is possible that the service will contain more functionality then what you define in the contract,<br>
but only the functions that are in the definition will be public (accessible) in the <a href="#distributed-environment">distributed environment</a>.</p>
<h2 id='3-creating-microservice'>3. creating microservice</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">createMicroservice</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube-microservice'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nx">createMicroservice</span><span class="p">({</span>
             <span class="na">services</span> <span class="p">:</span> <span class="p">[{</span>
               <span class="na">reference</span> <span class="p">:</span> <span class="p">{</span><span class="nx">someMethod</span><span class="p">},</span>
               <span class="na">definition</span><span class="p">:</span> <span class="nx">serviceDefinition</span>
             <span class="p">},</span>
             <span class="p">{</span>
                <span class="na">reference</span> <span class="p">:</span> <span class="k">new</span> <span class="nx">Service</span><span class="p">(),</span>
                <span class="na">definition</span><span class="p">:</span> <span class="nx">serviceDefinition</span>
              <span class="p">}]</span>
           <span class="p">});</span>
</code></pre><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">CreateMicroservice</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">MicroserviceOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Microservice</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">MicroserviceOptions</span> <span class="p">{</span>
  <span class="nx">services</span><span class="p">?:</span> <span class="nx">Service</span><span class="p">[];</span>
  <span class="nx">seedAddress</span><span class="p">?:</span> <span class="nx">Address</span> <span class="o">|</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nx">address</span><span class="p">?:</span> <span class="nx">Address</span> <span class="o">|</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nx">transport</span><span class="p">?:</span> <span class="nx">Transport</span><span class="p">;</span>
  <span class="nx">cluster</span><span class="p">?:</span> <span class="p">(</span><span class="nx">opt</span><span class="p">:</span> <span class="nx">ClusterOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Cluster</span><span class="p">;</span>
  <span class="nx">debug</span><span class="p">?:</span> <span class="kr">boolean</span><span class="p">;</span>
 <span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Service</span> <span class="p">{</span>
  <span class="nl">definition</span><span class="p">:</span> <span class="nx">ServiceDefinition</span><span class="p">;</span>
  <span class="nl">reference</span><span class="p">:</span> <span class="nx">ServiceReference</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>After creating a service and a service-definition we can now bootstrap our microservice.   </p>

<ul>
<li>services - An array of services, that will exist inside a microservice container.</li>
<li>seedAddress - <a href="#seedaddress">seedAddress</a> is the entry point to our distributed env.</li>
<li>address - An <a href="#address">address</a> for this microservice instance.</li>
<li>transport - optional pluggable <a href="#transport">transport</a>.</li>
<li>cluster - optional pluggable <a href="#cluster">cluster</a>.</li>
<li>debug - optional logs.</li>
</ul>
<h1 id='basic-usage'>Basic usage</h1>
<p>After bootstrapping the microservice, we can use it to request services from the <a href="#distributed-environment">distributed environment</a></p>
<h2 id='createproxy'>createProxy</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">CreateProxy</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">ProxyOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">ProxyOptions</span> <span class="p">{</span>
  <span class="nx">router</span><span class="p">?:</span> <span class="nx">Router</span><span class="p">;</span>
  <span class="nl">serviceDefinition</span><span class="p">:</span> <span class="nx">ServiceDefinition</span><span class="p">;</span>
<span class="p">}</span>

</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">serviceProxy</span> <span class="o">=</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">createProxy</span><span class="p">({</span><span class="nx">serviceDefinition</span><span class="p">});</span>
<span class="nx">serviceProxy</span><span class="p">.</span><span class="nx">someMethod</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span> <span class="c1">// resolve with `someMethod` response</span>
</code></pre>
<p>It is possible to createProxy from the microservice instance we have just created. </p>

<p>This is a proxy to a different service that is shared in the <a href="#distributed-environment">distributed environment</a>.</p>

<ul>
<li>router - Custom router specifies the logic of choosing the appropriate remoteService.</li>
<li>serviceDefinition - The metadata for a service container, that includes the name of a service and the map of methods that are included in it.</li>
</ul>
<h2 id='createservicecall'>createServiceCall</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">CreateServiceCall</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">CreateServiceCallOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ServiceCall</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">CreateServiceCallOptions</span> <span class="p">{</span>
  <span class="nx">router</span><span class="p">?:</span> <span class="nx">Router</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ServiceCall</span> <span class="p">{</span>
  <span class="nl">requestStream</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="nx">Message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">Message</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">requestResponse</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="nx">Message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Message</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">qualifier</span><span class="p">:</span> <span class="s1">'Service/someMethod'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">[</span><span class="s1">'value'</span><span class="p">]</span>
<span class="p">};</span>

<span class="nx">ms</span><span class="p">.</span><span class="nx">createServiceCall</span><span class="p">().</span><span class="nx">requestResponse</span><span class="p">(</span><span class="nx">message</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
<span class="nx">ms</span><span class="p">.</span><span class="nx">createServiceCall</span><span class="p">().</span><span class="nx">requestStream</span><span class="p">(</span><span class="nx">message</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>

</code></pre>
<p>serviceCall is another way to request a service.<br>
it is more low level approach and the user must define the <a href="#message"><code>message</code></a> properly in-order for it to work.</p>

<p>good example for preferring serviceCall over Proxy is in the <a href="#"><code>Gateway</code></a>,<br>
in the Gateway we want to receive a request from outside of our <a href="#distributed-environment">distributed environment</a> and then pass the request to the correct service inside ot it.</p>

<ul>
<li>router - Custom router specifies the logic of choosing the appropriate remoteService</li>
<li>requestStream - A method using which a consumer requires a stream and receives an Observable sequence describing updates of the method and qualifier that was used for the invocation</li>
<li>requestResponse - A method using which a consumer requires data and a provider responds with the data once in the form of promise,<br>
that includes the response from the method and qualifier that was used for the invocation.</li>
</ul>
<h2 id='createproxies'>createProxies</h2><pre class="highlight typescript tab-typescript"><code>
<span class="kd">type</span> <span class="nx">CreateProxies</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">CreateProxiesOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ProxiesMap</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">CreateProxiesOptions</span> <span class="p">{</span>
  <span class="nl">proxies</span><span class="p">:</span> <span class="nx">ProxiesOptions</span><span class="p">[];</span>
  <span class="nx">router</span><span class="p">?:</span> <span class="nx">Router</span><span class="p">;</span>
  <span class="nx">isAsync</span><span class="p">?:</span> <span class="kr">boolean</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ProxiesOptions</span> <span class="p">{</span>
  <span class="nl">proxyName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">serviceDefinition</span><span class="p">:</span> <span class="nx">ServiceDefinition</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ProxiesMap</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">proxyName</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span> <span class="na">proxy</span><span class="p">:</span> <span class="nx">Proxy</span> <span class="p">}</span><span class="o">&gt;</span> <span class="o">|</span> <span class="nx">Proxy</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Proxy</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">T</span><span class="p">;</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="p">{</span> <span class="nx">awaitServiceProxy</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">createProxies</span><span class="p">({</span>
  <span class="na">proxies</span><span class="p">:</span> <span class="p">[{</span>
    <span class="nx">serviceDefinition</span><span class="p">,</span>
    <span class="na">proxyName</span><span class="p">:</span> <span class="s1">'awaitServiceProxy'</span>
  <span class="p">}],</span>
  <span class="na">isAsync</span> <span class="p">:</span> <span class="kc">true</span>
<span class="p">});</span>

<span class="nx">awaitServiceProxy</span><span class="p">.</span><span class="nx">then</span><span class="p">(({</span><span class="na">proxy</span><span class="p">:</span> <span class="nx">serviceProxy</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">serviceProxy</span><span class="p">.</span><span class="nx">someMethod</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<p>createProxies is an advance way of creating a proxy to a service.
it provide a way to receive multiple proxies in one command.<br>
also, it provide two option of resolving the proxies:</p>

<ol>
<li><p>if setting the <code>isAsync</code> to <code>true</code> then you will receive 
an object with Promises to the proxies.</p></li>
<li><p>if setting the <code>isAsync</code> to <code>false</code> then you will receive 
an object with the proxies.</p></li>
</ol>

<p>promise to the proxy will resolve only when the service already in the registry.
this help you avoid retry logic till the service is available to use.</p>

<ul>
<li>proxies - List of ProxiesOptions, contain the configuration for creating the proxy</li>
<li>router - optional router to provide extra logic (remoteCall).</li>
<li>isAsync - optional flag to resolve the proxy asynchronous way<br>
if true then the proxy will be resolved when the service is in the registry.<br>
if false then the proxy will be resolved immediately.</li>
<li>proxyName - name of the proxy (used as the key in the map).</li>
<li>serviceDefinition - metadata of the service.</li>
<li>ProxiesMap - Map of generic proxyName and a Promise to the proxy.</li>
</ul>
<h2 id='destroy'>destroy</h2><pre class="highlight typescript tab-typescript"><code><span class="kr">interface</span> <span class="nx">Microservice</span> <span class="p">{</span>
  <span class="nl">destroy</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="nx">ms</span><span class="p">.</span><span class="nx">destroy</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</code></pre>
<p>destroy the microservice instance.</p>

<ol>
<li>stop listen to the <a href="#address">address</a>.<br></li>
<li>notify in the <a href="#distributed-environment">distributed environment</a> that the services from this microservice are not available anymore.<br></li>
<li>remove it self from the <a href="#distributed-environment">distributed environment</a>.<br></li>
</ol>

<ul>
<li>destroy - The method is used to delete a microservice and close all the subscriptions related with it.</li>
</ul>
<h1 id='advance-usage'>Advance usage</h1><h2 id='remotecall'>remoteCall</h2><pre class="highlight javascript tab-javascript"><code><span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">services</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">definition</span><span class="p">:</span> <span class="nx">serviceDefinition</span><span class="p">,</span>
    <span class="na">reference</span> <span class="p">:</span> <span class="k">new</span> <span class="nx">Service</span><span class="p">()</span>
  <span class="p">}],</span>
  <span class="na">address</span><span class="p">:</span> <span class="s1">'A'</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">localMs</span> <span class="o">=</span> <span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">seedAddress</span><span class="p">:</span> <span class="s1">'A'</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">proxyA</span> <span class="o">=</span> <span class="nx">localMs</span><span class="p">.</span><span class="nx">createProxy</span><span class="p">({</span><span class="nx">serviceDefinition</span><span class="p">});</span>

<span class="nx">proxyA</span><span class="p">.</span><span class="nx">someMethod</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
</code></pre>
<p>remoteCall is a request for a service that located in different microservice container in our <a href="#distributed-environment">distributed environment</a>,</p>

<p>the other microservice can be located on a different process and it will still be accessible with scalecube.</p>
<h2 id='dependency-hook'>dependency hook</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">ServiceFactory</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">createProxy</span><span class="p">,</span> <span class="nx">createServiceCall</span> <span class="p">}:</span> <span class="nx">ServiceFactoryOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ServiceObject</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">ServiceFactoryOptions</span> <span class="p">{</span>
  <span class="nl">createProxy</span><span class="p">:</span> <span class="nx">CreateProxy</span><span class="p">;</span>
  <span class="nl">createServiceCall</span><span class="p">:</span> <span class="nx">CreateServiceCall</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ServiceObject</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">?:</span> <span class="kr">any</span><span class="p">;</span>

  <span class="p">[</span><span class="nx">methodName</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">createMicroservice</span><span class="p">,</span> <span class="nx">ASYNC_MODEL_TYPES</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube@scalecube/scalecube-microservice'</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">definitionA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">serviceName</span><span class="p">:</span> <span class="s1">'serviceA'</span><span class="p">,</span>
    <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">someMethodA</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">asyncModel</span><span class="p">:</span> <span class="nx">ASYNC_MODEL_TYPES</span><span class="p">.</span><span class="nx">REQUEST_RESPONSE</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">definitionB</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">serviceName</span><span class="p">:</span> <span class="s1">'serviceB'</span><span class="p">,</span>
    <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">someMethodB</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">asyncModel</span><span class="p">:</span> <span class="nx">ASYNC_MODEL_TYPES</span><span class="p">.</span><span class="nx">REQUEST_RESPONSE</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kr">class</span> <span class="nx">ServiceB</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">(</span><span class="nx">proxyA</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// work with proxy to serviceA</span>
      <span class="nx">proxyA</span><span class="p">.</span><span class="nx">someMethodA</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">services</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">definition</span><span class="p">:</span> <span class="nx">definitionA</span><span class="p">,</span>
      <span class="na">reference</span> <span class="p">:</span> <span class="p">{</span> <span class="nx">someMethodA</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">definition</span><span class="p">:</span> <span class="nx">definitionB</span><span class="p">,</span>
      <span class="na">reference</span><span class="p">:</span> <span class="p">({</span> <span class="nx">createProxy</span><span class="p">,</span> <span class="nx">createServiceCall</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">proxyA</span> <span class="o">=</span> <span class="nx">createProxy</span><span class="p">({</span><span class="na">serviceDefinition</span><span class="p">:</span> <span class="nx">definitionA</span> <span class="p">});</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">ServiceB</span><span class="p">(</span><span class="nx">proxyA</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>    
  <span class="p">]</span>
<span class="p">})</span>
</code></pre>
<p>dependency hook is used if your service deepened on another service,<br>
or if you want to add life cycle to your bootstrap process.</p>
<h3 id='injectproxy-example'>injectProxy example:</h3>
<p>In the example we have two services with dependency between them,<br>
ServiceB deepened on ServiceA.</p>

<p>instead of passing the class instance of serviceB in the reference, we are passing a callback.</p>

<p>the callback is called from scalecube as part of the bootstrapping process.<br>
the callback will be called with createProxy or createServiceCall methods which allow us to create proxy to serviceA and inject it to ServiceB constructor.</p>

<p>this technique can be apply to modules by passing the proxy to a factory.</p>
<h2 id='gateway'>gateway</h2><pre class="highlight typescript tab-typescript"><code><span class="kd">type</span> <span class="nx">RequestHandler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">serviceCall</span><span class="p">:</span> <span class="nx">ServiceCall</span><span class="p">,</span> <span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">subscriber</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">GatewayOptions</span> <span class="p">{</span>
  <span class="nl">port</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nx">requestResponse</span><span class="p">?:</span> <span class="nx">RequestHandler</span><span class="p">;</span>
  <span class="nx">requestStream</span><span class="p">?:</span> <span class="nx">RequestHandler</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">GatewayStartOptions</span> <span class="p">{</span>
  <span class="nl">serviceCall</span><span class="p">:</span> <span class="nx">ServiceCall</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Gateway</span> <span class="p">{</span>
  <span class="nl">start</span><span class="p">:</span> <span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">GatewayStartOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">stop</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span><span class="nx">Gateway</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/rsocket-ws-gateway'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">createMicroservice</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">'@scalecube/scalecube-microservice'</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">gateway</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Gateway</span><span class="p">({</span><span class="na">port</span> <span class="p">:</span> <span class="mi">3000</span><span class="p">});</span>
<span class="kr">const</span> <span class="nx">serviceCall</span> <span class="o">=</span> <span class="nx">createMicroservice</span><span class="p">({</span>
  <span class="na">services</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">reference</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Service</span><span class="p">(),</span>
    <span class="na">definition</span><span class="p">:</span> <span class="nx">serviceDefinition</span>
  <span class="p">}]</span>
<span class="p">}).</span><span class="nx">createServiceCall</span><span class="p">({});</span>

<span class="nx">gateway</span><span class="p">.</span><span class="nx">start</span><span class="p">({</span><span class="nx">serviceCall</span><span class="p">});</span>
</code></pre>
<p>Its a technique to centralize all the requests that are coming from outside of the distributed environment.</p>

<p>scalecube provide gateway implementation base on RSocketWebsocket.</p>

<ul>
<li>port - The gateway will listen to it.</li>
<li>requestResponse - handle requestResponse requests.</li>
<li><p>requestStream - handle requestStream requests.</p></li>
<li><p><a href="#createservicecall">serviceCall</a> - low level approach for requesting a service in the distributed environment.</p></li>
<li><p>start - start the gateway.</p></li>
<li><p>stop - stop the gateway.</p></li>
</ul>
<h1 id='debug'>Debug</h1><h2 id='mocks'>Mocks</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'@scalecube/utils'</span><span class="p">);</span>

<span class="c1">// polyfill for messageChannel</span>
<span class="nx">utils</span><span class="p">.</span><span class="nx">mockMessageChannel</span><span class="p">();</span>
</code></pre>
<p>When trying to test app as if running on browser 
and testing microservices in node environment (jest) 
and the test involve multiple microservice instances
and performing <a href="#remotecall">remoteCall</a> then it is require to 
add the code snippet before the test is running.</p>

<p>the snippet will mock scalecube check if running in node
and will add polyfill <a href="https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel">messageChannel</a> which required by browser implementation of scalecube.</p>
<h1 id='errors'>Errors</h1>
<table><thead>
<tr>
<th>Error Code</th>
<th>Message</th>
<th>Possible solution</th>
</tr>
</thead><tbody>
<tr>
<td>MS0000</td>
<td>microservice does not exists</td>
<td>microservice instance have been destroyed</td>
</tr>
<tr>
<td>MS0001</td>
<td><a href="#message">Message</a> has not been provided</td>
<td>calling requestResponse or requestStream must contain a Message</td>
</tr>
<tr>
<td>MS0002</td>
<td><a href="#message">Message</a> data has not been provided</td>
<td>Message must contain data property</td>
</tr>
<tr>
<td>MS0003</td>
<td><a href="#message">Message</a> qualifier has not been provided</td>
<td>Message must contain qualifier property</td>
</tr>
<tr>
<td>MS0004</td>
<td><a href="#message">Message</a> should not to be empty object</td>
<td>can not pass empty object as Message</td>
</tr>
<tr>
<td>MS0005</td>
<td><a href="#qualifier">qualifier</a> expected to be service/method format</td>
<td>qualifier is not a string divided by &#39;/&#39;</td>
</tr>
<tr>
<td>MS0006</td>
<td><a href="#service">Service</a> missing definition</td>
<td>when <a href="#bootstrap">bootstrap microservice</a> you provide service without a contract</td>
</tr>
<tr>
<td>MS0007</td>
<td><a href="#message">Message</a> format error: data must be Array</td>
<td>Message data property must be array, <a href="#passing-array-serviceall">how can i pass array in message</a></td>
</tr>
<tr>
<td>MS0008</td>
<td>Not valid format, <a href="#3-creating-microservice">services</a> must be Array</td>
<td>when <a href="#bootstrap">bootstrap microservice</a>, services must be array of service</td>
</tr>
<tr>
<td>MS0009</td>
<td>Not valid format, <a href="#service">service</a> must be Object</td>
<td>service must be an object</td>
</tr>
<tr>
<td>MS0010</td>
<td>Not valid format, <a href="#microservice">Microservice configuration</a> must be an Object</td>
<td>missing configuration when bootstrapping a microservice instance</td>
</tr>
<tr>
<td>MS0011</td>
<td><a href="#qualifier">qualifier</a> should not be empty string</td>
<td>qualifier must be valid string in the format &#39;part1/part2&#39;</td>
</tr>
<tr>
<td>MS0012</td>
<td>Invalid <a href="##createproxies">createProxies</a> configuration, proxyName must be unique</td>
<td>when createProxies you are passing the same proxyName twice</td>
</tr>
<tr>
<td>MS0013</td>
<td>Transport provider is not define</td>
<td>when running on nodejs, <a href="#transport">Transport</a> must be provided</td>
</tr>
<tr>
<td>MS0014</td>
<td>service method <methodName> missing in the <a href="#1-define-the-service">serviceDefinition</a></td>
<td>try to call a method from a proxy that does not in the definition</td>
</tr>
<tr>
<td>MS0015</td>
<td>can&#39;t find services that match the give criteria: &lt;<a href="#qualifier">qualifier</a>&gt;</td>
<td>requesting a service that is not in the <a href="#registry">registry</a></td>
</tr>
<tr>
<td>MS0016</td>
<td>&lt;<a href="#asyncmodel">asyncModel</a> does not match, expect asyncModel in the proxy definition&gt;, but received <asyncModel in the endpoint definition></td>
<td>asyncModel in the request does not match the asyncModel define in the registry for the service</td>
</tr>
<tr>
<td>MS0017</td>
<td>service (&lt;<a href="#qualifier">qualifier</a>&gt;) has valid definition but reference is not a function.</td>
<td><a href="#2-create-the-servicereference">ServiceObject</a> method is not a function</td>
</tr>
<tr>
<td>MS0018</td>
<td>service does not uphold the contract, <serviceName> is not provided</td>
<td>definition has a method that is not provided in the reference</td>
</tr>
<tr>
<td>MS0019</td>
<td>Not valid format, <serviceName> reference must be an Object</td>
<td><a href="#2-create-the-servicereference">ServiceReference</a> must return object</td>
</tr>
<tr>
<td>MS0020</td>
<td>Invalid format, definition must contain valid serviceName</td>
<td>serviceDefinition must contain property <code>serviceName</code></td>
</tr>
<tr>
<td>MS0021</td>
<td>Invalid format, definition must contain valid methods of type object</td>
<td>methods must be of type object</td>
</tr>
<tr>
<td>MS0022</td>
<td>Invalid format, definition must contain valid methods</td>
<td>methods must be none empty object</td>
</tr>
<tr>
<td>MS0023</td>
<td>Invalid format, serviceName must be not empty string but received type <typeof serviceName></td>
<td>fix the serviceDefinition, serviceName must be a string</td>
</tr>
</tbody></table>
<h1 id='faq'>FAQ</h1><h2 id='how-can-i-pass-array-in-message'>How can I pass array in message?</h2><pre class="highlight javascript tab-javascript"><code>
<span class="kr">const</span> <span class="nx">arrayToPassInArgs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">];</span>
<span class="kr">const</span> <span class="nx">valueToPassInArgs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">objectToPassInArgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'6'</span><span class="p">:</span><span class="mi">6</span><span class="p">};</span>

<span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">qualifier</span> <span class="p">:</span> <span class="s1">'Service/someMethod'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">[</span><span class="nx">arrayToPassInArgs</span><span class="p">,</span> <span class="nx">valueToPassInArgs</span><span class="p">,</span> <span class="nx">objectToPassInArgs</span><span class="p">]</span>
<span class="p">}</span>

</code></pre>
<p>It is possbile to pass any data structure in the message.<br>
just need to make sure it wrap in array.</p>

<p>please look at the <a href="?javascript#passing-array-argument-in-message">example</a></p>
<h3 id='related-topics'>related topics:</h3>
<p><a href="#message">message</a></p>
<h2 id='invoking-a-method-from-proxy-throw-error-code-ms0015-can-39-t-find-services'>Invoking a method from proxy throw error code MS0015 - can&#39;t find services ...</h2>
<p>createProxy or createProxies (without asyncModel flag set to true) does not guarantee that the service is available.</p>

<p>it just provide a proxy to the service.</p>
<h3 id='possible-solutions'>possible solutions:</h3>
<ol>
<li><p>set asyncModel flag to true when using <a href="#createproxies">createProxies</a>.<br>
this option will provide a promise to a proxy.
when calling the promise, it will resolve when the service is available.</p></li>
<li><p>using retryRouter when creating the proxy.
retryRouter will ping the registry before the remoteCall till the service is registered.</p></li>
</ol>
<h3 id='related-topics-2'>related topics:</h3>
<p><a href="#createproxies">createProxies</a>, <a href="#remotecall">remoteCall</a>, <a href="#router">retryRouter</a></p>
<h2 id='does-the-order-of-services-is-important-when-using-the-dependency-hook'>Does the order of services is important when using the dependency hook?</h2>
<p>The order of the services you provide is the order in which they are registered in the registry.</p>

<p>but, you don&#39;t need the service in the registry in order to create a proxy to it.</p>

<p>farther more, it is possible to use the dependency hook for services that are located in other microservice instances. </p>
<h3 id='possible-solution'>possible solution:</h3>
<p>it is common to apply retry logic in order to make sure the service will run.</p>
<h3 id='related-topics-3'>related topics:</h3>
<p><a href="#remotecall">remoteCall</a></p>
<h2 id='does-seedaddress-and-address-are-mandatory-for-scalecube'>Does seedAddress and address are mandatory for scalecube?</h2>
<p>No, they are both optional.</p>
<h3 id='why-to-provide-seedaddress'>Why to provide seedAddress?</h3>
<p>seedAddress is used to connected to a distributed environment.</p>

<p>you must provide the address to one of the microservice instance in the distributed environment you want to joined.</p>
<h3 id='why-to-provide-address'>why to provide address?</h3>
<p>It is important to set your microservice instance address 
if you want that other microservice instance will use it as seedAddress.</p>

<p>farther more, microservice without address won&#39;t be able to share it services in the distributed environment.</p>

<p>if no address is provided, then microservice bootstrap will generate address for you. 
auto generate address stop you from sharing your services in the distributed environment.</p>
<h3 id='related-topics-4'>related topics:</h3>
<p><a href="#remotecall">remoteCall</a>, <a href="#distributed-environment">distributed environment</a>, <a href="#seed">seed</a>, <a href="#address">address</a></p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="typescript">api</a>
                <a href="#" data-language-name="javascript">example</a>
          </div>
      </div>
    </div>
  </body>
</html>
